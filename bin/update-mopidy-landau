#!/usr/bin/env bash

# Archive current image
ssh landau "docker stop mopidy;\
docker stop mopidy-prev;\
docker rm -v mopidy-prev;\
docker rename mopidy mopidy-prev"

# Run with new image
ssh landau '$(aws ecr get-login --no-include-email --region eu-west-1) && \
docker pull 473900256917.dkr.ecr.eu-west-1.amazonaws.com/mopidy && \
docker run --detach --restart=always \
-p 6680:6680 -p 6600:6600 \
--device /dev/snd \
--mount type=bind,source=/var/local/docker/mopidy/media,target=/var/lib/mopidy/media,readonly \
--mount type=bind,source=/var/local/docker/mopidy/local,target=/var/lib/mopidy/local \
--mount type=bind,source=/var/local/docker/mopidy/playlists,target=/var/lib/mopidy/playlists \
--name mopidy \
473900256917.dkr.ecr.eu-west-1.amazonaws.com/mopidy'
